@page "/attack-3-round-2"

@using System.Globalization
@using NuminaBit.Services.Ciphers.DES.Entities;

@inject ILogger<Attack3Round2> Log
@inject NuminaBit.Services.Ciphers.DES.Interfaces.IAttackRunner2 _attack


<RadzenCard Style="margin:1rem;">
  <ChildContent>
    <div class="grid md:grid-cols-2 gap-4">
      <!-- Left column: Inputs & controls -->
      <div class="space-y-3">
        <RadzenFieldset Text="Inputs">
          <div class="grid grid-cols-1 gap-2">
            <RadzenTextBox style="width:100%" Placeholder="16 hex" @bind-Value="KeyHex" Disabled="@UseHiddenKey" />
            <div class="text-xs text-gray-500">Key (64-bit hex). Hover for binary/utf8.</div>
            <div class="flex items-center gap-2">
              <RadzenCheckBox @bind-Value="UseHiddenKey" />
              <label class="text-sm">Use hidden system key</label>
            </div>

            <div class="flex items-center gap-2">
              <label class="text-sm">Pairs per trial</label>
              <RadzenDropDown Data="@PairCounts" @bind-Value="PairsPerTrial" Style="width:120px" />
            </div>

            <div class="flex items-center gap-2">
              <label class="text-sm">Number of trials</label>
              <RadzenDropDown Data="@TrialsOptions" @bind-Value="TrialsCount" Style="width:120px" />
            </div>

            <div class="flex gap-2 mt-2">
              <RadzenButton Icon="play_arrow" Text="Run Trials" ButtonStyle="ButtonStyle.Primary" Click="RunTrials" Disabled="@IsRunning" />
              <RadzenButton Icon="refresh" Text="Clear Results" Click="ClearResults" Disabled="@IsRunning" />
            </div>

            <RadzenProgressBar Mode="ProgressBarMode.Determinate" Value="@ProgressPct" Visible="@IsRunning" />
          </div>
        </RadzenFieldset>

        <RadzenFieldset Text="Key Viewer (K1 & K3)">
          <div class="text-sm space-y-2 p-2">
            <div>Key (hex): <strong>@DisplayKeyHex</strong></div>
            <div title="@KeyBinaryTooltip">Key (binary): <code style="font-family:monospace">@KeyBinaryShort</code> … (hover for full)</div>
            <div class="mt-2">
              <div><b>K1 (round1 subkey, 48-bit):</b></div>
              <pre style="font-family:monospace">@K1Binary</pre>
              <div><b>K3 (round3 subkey, 48-bit):</b></div>
              <pre style="font-family:monospace">@K3Binary</pre>
              <div class="mt-1 text-sm">Highlighted bit: <b>pos 22</b> (1-indexed in subkey). Values: K1[22]=@K1Bit22, K3[22]=@K3Bit22</div>
            </div>
          </div>
        </RadzenFieldset>

      </div>

      <!-- Right column: Results and visualization -->
      <div class="space-y-3">
        <RadzenFieldset Text="Trials Results">
          <div>
            <RadzenDataGrid Data="@Outcomes"  KeyProperty="Id" TItem="TrialOutcome" AllowVirtualization="true" ColumnWidth="200px" Style="height:260px">
              <Columns>
                <RadzenDataGridColumn TItem="TrialOutcome" Property="Pairs" Title="Pairs" />
                <RadzenDataGridColumn TItem="TrialOutcome" Property="CountZero" Title="Count of 0's'" />
                <RadzenDataGridColumn TItem="TrialOutcome" Property="CountOne" Title="Count of 1's'" />
                <RadzenDataGridColumn TItem="TrialOutcome" Property="GuessedBit" Title="Guessed" />
                <RadzenDataGridColumn TItem="TrialOutcome" Property="ActualBit" Title="Actual" />
                <RadzenDataGridColumn TItem="TrialOutcome" Property="Success" Title="Success" />
              </Columns>
            </RadzenDataGrid>
          </div>
        </RadzenFieldset>

        <RadzenFieldset Text="Success Rate Chart">
            <div style="height:240px">
                <RadzenChart Style="height:220px">
                    <RadzenCategoryAxis>
                        <RadzenAxisTitle Text="Category" /> <!-- Add your category title here -->
                    </RadzenCategoryAxis>

                    <RadzenValueAxis Min="0" Max="100">
                        <RadzenAxisTitle Text="Success Rate (%)" /> <!-- Add your value axis title here -->
                    </RadzenValueAxis>

                    <RadzenLineSeries Data="@CumulativeSuccessPercent" CategoryProperty="Key" ValueProperty="Value" StrokeWidth="3" />
                </RadzenChart>
            </div>
        </RadzenFieldset>

        <RadzenFieldset Text="Summary">
          <div class="p-2 text-sm">
            <div>Total Trials: @Outcomes.Count</div>
            <div>Successful Trials: @Outcomes.Count(o=>o.Success)</div>
            <div>Final Cumulative Success %: @FinalSuccessPercent.ToString("F1")%</div>
          </div>
        </RadzenFieldset>
      </div>
    </div>
  </ChildContent>
</RadzenCard>